---
import Layout from '@/layouts/Layout.astro'
import PagefindSearch from 'astro-pagefind/components/Search'
---

<Layout>
  <section class="mx-auto flex w-full max-w-3xl flex-col gap-y-6">
    <header class="flex flex-col gap-2">
      <h1 class="text-3xl leading-tight font-medium">Search</h1>
      <p class="text-muted-foreground text-sm">
        Search posts by title, description, tags, or content.
      </p>
    </header>

    <PagefindSearch
      id="search"
      className="pagefind-ui"
      uiOptions={{ showImages: false }}
    />
  </section>
</Layout>

<script>
  const applyQuery = () => {
    const params = new URLSearchParams(window.location.search)
    const query = params.get('q')
    if (!query) return

    let attempts = 0
    const timer = window.setInterval(() => {
      const input = document.querySelector<HTMLInputElement>(
        '.pagefind-ui__search-input',
      )
      if (input) {
        input.value = query
        input.dispatchEvent(new Event('input', { bubbles: true }))
        window.clearInterval(timer)
      }
      attempts += 1
      if (attempts >= 20) {
        window.clearInterval(timer)
      }
    }, 100)
  }

  document.addEventListener('astro:page-load', applyQuery)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyQuery)
  } else {
    applyQuery()
  }
</script>
